{"componentChunkName":"component---src-templates-blog-post-js","path":"/develop/mall-fashion/mall5/","result":{"data":{"site":{"siteMetadata":{"title":"Godo dev"}},"markdownRemark":{"id":"517f8966-1207-53fa-9b6b-c2b59b61f12b","excerpt":"도입 배경 이번 포스트는 의존성 주입에 의한 런타임 인스턴스 의존관계가 아닌 외부 라이브러리에 대한 클래스 간 의존 관계 때문에 테스팅이 어려워지고 재사용과 확장이 어려웠던 코드를 SRP 원칙에 따라 역할을 구분하고 OCP원칙과 DIP…","html":"<h2>도입 배경</h2>\n<p>이번 포스트는 의존성 주입에 의한 런타임 인스턴스 의존관계가 아닌 외부 라이브러리에 대한 클래스 간 의존 관계 때문에 테스팅이 어려워지고 재사용과 확장이 어려웠던 코드를 SRP 원칙에 따라 역할을 구분하고 OCP원칙과 DIP원칙을 적용하면서 해당 문제점들을 해결한 경험을 공유하고자 합니다.</p>\n<p>현재 프로젝트는 전화번호 인증을 위해 <a href=\"https://coolsms.co.kr/\">COOL SMS API</a>를 사용하고 있습니다. 인증을 위해 필요한 정보들을 @Value를 통해 런타임으로 가져오고 COOL SMS API가 제공하는 <code class=\"language-text\">DefaultMessageService</code> 클래스의 <code class=\"language-text\">sendOne</code> 메소드를 통해 문자를 전송합니다. 해당 코드는 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">VerificationService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${coolsms.api.key}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> apiKey<span class=\"token punctuation\">;</span>\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${coolsms.api.secret}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> apiSecretKey<span class=\"token punctuation\">;</span>\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${coolsms.api.number}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> from<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Random</span> random <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">REDIS_VERIFY_CODE_KEY_PREFIX</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"verification-code:\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> <span class=\"token constant\">CODE_EXPIRED_TIME_IN_MILLISECONDS</span> <span class=\"token operator\">=</span> <span class=\"token number\">30</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">DefaultMessageService</span> messageService <span class=\"token operator\">=</span> <span class=\"token class-name\">NurigoApp</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INSTANCE</span><span class=\"token punctuation\">.</span><span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span>apiKey<span class=\"token punctuation\">,</span> apiSecretKey<span class=\"token punctuation\">,</span> <span class=\"token string\">\"https://api.coolsms.co.kr\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RedisUtils</span> redisUtils<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">sendOne</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token keyword\">to</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">String</span> code <span class=\"token operator\">=</span> <span class=\"token function\">generateCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Message</span> message <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Message</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        message<span class=\"token punctuation\">.</span><span class=\"token function\">setFrom</span><span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        message<span class=\"token punctuation\">.</span><span class=\"token function\">setTo</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">to</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        message<span class=\"token punctuation\">.</span><span class=\"token function\">setText</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[MallFashion] 아래의 인증번호를 입력해주세요\\n\"</span> <span class=\"token operator\">+</span> code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        redisUtils<span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token constant\">REDIS_VERIFY_CODE_KEY_PREFIX</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">to</span><span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">,</span> <span class=\"token constant\">CODE_EXPIRED_TIME_IN_MILLISECONDS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        messageService<span class=\"token punctuation\">.</span><span class=\"token function\">sendOne</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">SingleMessageSendingRequest</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">generateCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span> <span class=\"token operator\">+</span> random<span class=\"token punctuation\">.</span><span class=\"token function\">nextInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">9000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>동작원리는 간단합니다.</p>\n<h3>객체 초기화</h3>\n<ol>\n<li>messageService 필드 초기화합니다.</li>\n<li>랜덤한 인증번호를 생성하는 <code class=\"language-text\">Random</code> 클래스 인스턴스를 생성합니다.</li>\n<li>인증정보를 캐싱하는 <code class=\"language-text\">RedisUtils</code> 를 생성자 주입받습니다.</li>\n</ol>\n<h3>문자 전송 메소드(sendOne)</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">String</span> code <span class=\"token operator\">=</span> <span class=\"token function\">generateVerificationCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>랜덤한 인증 코드를 생성합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Message</span> message <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Message</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        message<span class=\"token punctuation\">.</span><span class=\"token function\">setFrom</span><span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        message<span class=\"token punctuation\">.</span><span class=\"token function\">setTo</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">to</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        message<span class=\"token punctuation\">.</span><span class=\"token function\">setText</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[MallFashion] 아래의 인증번호를 입력해주세요\\n\"</span> <span class=\"token operator\">+</span> code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>전송할 메시지 객체를 초기화합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">redisUtils<span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token constant\">REDIS_VERIFY_CODE_KEY_PREFIX</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">to</span><span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">,</span> <span class=\"token constant\">CODE_EXPIRED_TIME_IN_MILLISECONDS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Redis 캐시 서버에 전화번호와 인증번호를 key-value 형태로 저장합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">messageService<span class=\"token punctuation\">.</span><span class=\"token function\">sendOne</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">SingleMessageSendingRequest</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">DefaultMessageService</code> 클래스의 <code class=\"language-text\">sendOne</code> 메소드를 통해 문자를 전송합니다.</p>\n<h2>테스트 작성에서 드러난 문제</h2>\n<p>해당 코드를 작성하고 정상 작동 여부를 테스트 서버에서 확인했을 때는 큰 문제가 없어보였습니다. 하지만 문제는 테스트 코드를 작성할 때 나타났습니다.</p>\n<p>현재 <code class=\"language-text\">VerificationService</code> 가 갖고 있는 역할은 아래와 같습니다.</p>\n<ul>\n<li>messageService 필드 초기화</li>\n<li>랜덤한 코드 생성</li>\n<li><code class=\"language-text\">redisUtils</code>에게 캐싱해야 할 정보(메시지)와 함께 <code class=\"language-text\">setData</code> 메소드 호출</li>\n<li><code class=\"language-text\">messageService</code>에게 메시지 객체와 함께 <code class=\"language-text\">sendOne</code> 메소드 호출</li>\n</ul>\n<p>즉 정리하자면 VerificationService는 메시지 전송을 위해 messageService 필드 초기화와 랜덤한 코드 생성은 직접 담당하고 <code class=\"language-text\">redisUtils</code>, 그리고 <code class=\"language-text\">messageService</code>과 협력하고 있습니다.</p>\n<h3>1. 구현의 캡슐화로 인한 테스트의 어려움</h3>\n<p>messageService 필드 초기화와 랜덤한 코드 생성은 메소드로서 정의가 되어있는 것이 아닌 <code class=\"language-text\">sendOne</code> 메소드 내부에서 사용되기 때문에 <code class=\"language-text\">VerificationService</code>의 세부 구현으로서 캡슐화가 되게 되고 이는 해당 역할들에 대한 테스트를 불가능하게 만들었습니다.</p>\n<h3>2. 모의 객체 생성의 어려움</h3>\n<p><code class=\"language-text\">sendOne</code>이 제대로 동작하는지 확인하기 위해서 실제로 문자를 전송하는 부분과 랜덤한 인증코드를 생성하는 부분을 stub을 통해서 모킹할 수 있습니다. 하지만 <code class=\"language-text\">messageService</code>의 경우 <code class=\"language-text\">@Value</code>에 의해 런타임에 값이 정해지는 값들에 의존하고 있어 모의 객체를 생성할 수 없습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">when</span><span class=\"token punctuation\">(</span>defaultMessageService<span class=\"token punctuation\">.</span><span class=\"token function\">sendOne</span><span class=\"token punctuation\">(</span><span class=\"token function\">any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">thenReturn</span><span class=\"token punctuation\">(</span><span class=\"token function\">mock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>실제로 위와 같이 defaultMessageService가 호출되었을 때 실제로 메소드가 수행되는 것이 아닌 모의 객체를 반환하도록 stub 을 설정했을 때 예외가 발생합니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/045197e3c4132843426ce90f6e0c02a6/3d68f/mall5-exception.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.417721518987342%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAzklEQVR42l2QzXLDIBCDeZE0xmDAgBPbbdNDf9K+/0OpEmZyyOEbrWx2Z7Xmy2XcfWn8NDJ+u7+OAesYsdqAnSrkK/2FFDthoQo/ONizg9GPjY+unbU37vreBiVsLuHVH+wuInOQhqXBt+HyiczEbDbiTU3joeLmZtRYsMSKPFdYFzAQ6ek8Pnh5qoX5YPMf430y6nfnPhW8pwW3dGla/IwyzVhI4YaBmwXrEbnRpJpEotpoTUVU9NrvUZryPsNxo6yYncq36lHM2jU/fMA/k7mR2QjY0I8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"exception\"\n        title=\"\"\n        src=\"/static/045197e3c4132843426ce90f6e0c02a6/f058b/mall5-exception.png\"\n        srcset=\"/static/045197e3c4132843426ce90f6e0c02a6/c26ae/mall5-exception.png 158w,\n/static/045197e3c4132843426ce90f6e0c02a6/6bdcf/mall5-exception.png 315w,\n/static/045197e3c4132843426ce90f6e0c02a6/f058b/mall5-exception.png 630w,\n/static/045197e3c4132843426ce90f6e0c02a6/40601/mall5-exception.png 945w,\n/static/045197e3c4132843426ce90f6e0c02a6/78612/mall5-exception.png 1260w,\n/static/045197e3c4132843426ce90f6e0c02a6/3d68f/mall5-exception.png 2282w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>이는 <code class=\"language-text\">VerificationService</code> 클래스가 자신의 필드를 이용해 <code class=\"language-text\">defaultMessageService</code>를 직접 초기화하기 때문에 발생합니다. 결국 우리는 성공하는 테스트를 작성하기 위해서 <code class=\"language-text\">VerificationService</code>의 <code class=\"language-text\">apiKey</code>, <code class=\"language-text\">apiSecret</code>, <code class=\"language-text\">from</code> 을 모두 주입해주어야 합니다.</p>\n<p>이러한 모의객체 생성의 어려움 때문에 우리는 정말 테스트하고 싶은 로직, 예를 들면 생성된 인증코드가 캐시서버에 잘 저장되는지, 생성된 인증코드와 문자로 발송된 인증코드가 일치하는지 등의 로직을 검증하기 어렵게 됩니다.</p>\n<blockquote>\n<p>테스트 작성의 복잡성은 해당 구현이 올바른지에 대해 가늠하는 척도가 됩니다.</p>\n<p>단위 테스트 | 블라디미르 코리코프</p>\n</blockquote>\n<p>그렇다면 이 문제를 어떻게 해결하면 될까요?</p>\n<p>정답은 의외로 간단합니다. 모킹이 어려운 부분을 다른 책임으로 구분하여 해당 책임을 가진 인스턴스를 생성하는 것입니다. 모킹을 한다는 것은 해당 객체가 갖는 핵심 로직이 아닐 가능성이 큽니다. 결국 그 부분에 대한 책임을 분리하면서 우리는 여러가지 효과를 얻을 수 있습니다.</p>\n<ul>\n<li>SRP 원칙을 지킬 수 있게 됩니다.</li>\n<li>책임을 분리함으로써 우리가 테스트하고 싶은 로직만 테스팅할 수 있습니다.</li>\n<li>불필요한 테스트 설정에 드는 노력을 줄여줍니다.</li>\n<li>분리된 책임의 단위 테스트가 가능해집니다.</li>\n</ul>\n<h2>그리고 확장 가능성</h2>\n<p>커머스 서비스의 특성상 전화번호 인증 자체에 대한 로직의 변경 가능성은 크지 않습니다. 하지만 전화번호 인증을 위해 사용하는 구현 기술은 충분히 변경의 여지가 많습니다. 현재 COOL SMS API를 사용하고 있지만 더 좋은 서비스가 등장할 수도 있기 때문입니다.</p>\n<p>현재 코드는 COOL SMS가 제공하는 클래스들에 직접적으로 의존하고 있습니다. 이는 다른 기술로 변경해야 할 때 모두 변경해야할 코드가 될 것이며 그 코드의 양이 방대해진다면 더 좋은 기술이 있음에도 선뜻 다른 기술로의 이동을 망설이게 되는 기술 부채로써 작용할 수 있을 것입니다.</p>\n<p>하지만 전화번호 인증 서비스가 문자 서비스의 추상화에 의존하게 된다면 이러한 문제로부터 벗어날 수 있을 것입니다.</p>\n<h2>변경된 코드</h2>\n<p>이메일을 전송하는 역할만을 갖는 <code class=\"language-text\">SmsService</code>를 정의하고 그것을 CoolSMS를 통해 구현하는 구체 클래스 <code class=\"language-text\">CoolSmsService</code>을 정의했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CoolSmsService</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">SmsService</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MessageFactory</span> messageFactory<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">DefaultMessageService</span> messageService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">sendOne</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token keyword\">to</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        messageService<span class=\"token punctuation\">.</span><span class=\"token function\">sendOne</span><span class=\"token punctuation\">(</span>\n                <span class=\"token keyword\">new</span> <span class=\"token class-name\">SingleMessageSendingRequest</span><span class=\"token punctuation\">(</span>messageFactory<span class=\"token punctuation\">.</span><span class=\"token function\">createMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">to</span><span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>기존의 <code class=\"language-text\">VerificationService</code>는 <code class=\"language-text\">SmsService</code>이라는 인터페이스에 의존하게 함으로써 구체적인 기술에 더이상 의존하지 않게 되었습니다. 이로써 <code class=\"language-text\">VerificationService</code>는 인증코드를 확인하는 역할만 수행할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">VerificationService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">SmsService</span> smsService<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RandomCodeGenerator</span> randomCodeGenerator<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RedisRepository</span> redisRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">REDIS_VERIFY_CODE_KEY_PREFIX</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"verification-code:\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">REDIS_VERIFIED_PHONE_NUMBER_PREFIX</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"verified-phone-number:\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> <span class=\"token constant\">CODE_EXPIRED_TIME_IN_MILLISECONDS</span> <span class=\"token operator\">=</span> <span class=\"token number\">300</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> <span class=\"token constant\">VERIFIED_ID_EXPIRED_TIME_IN_MILLISECONDS</span> <span class=\"token operator\">=</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">sendMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> recipientPhoneNumber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">String</span> code <span class=\"token operator\">=</span> <span class=\"token function\">generateVerificationCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        smsService<span class=\"token punctuation\">.</span><span class=\"token function\">sendOne</span><span class=\"token punctuation\">(</span>recipientPhoneNumber<span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        redisRepository<span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span>\n                <span class=\"token constant\">REDIS_VERIFY_CODE_KEY_PREFIX</span> <span class=\"token operator\">+</span> recipientPhoneNumber<span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">,</span> <span class=\"token constant\">CODE_EXPIRED_TIME_IN_MILLISECONDS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">generateVerificationCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> randomCodeGenerator<span class=\"token punctuation\">.</span><span class=\"token function\">generate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">verifyCodeWithPhoneNumber</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> phoneNumber<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">String</span> cachedCode <span class=\"token operator\">=</span> redisRepository<span class=\"token punctuation\">.</span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token constant\">REDIS_VERIFY_CODE_KEY_PREFIX</span> <span class=\"token operator\">+</span> phoneNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cachedCode <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>cachedCode<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApiException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorEnum</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INVALID_REQUEST</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        redisRepository<span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token constant\">REDIS_VERIFIED_PHONE_NUMBER_PREFIX</span> <span class=\"token operator\">+</span> phoneNumber<span class=\"token punctuation\">,</span>\n                phoneNumber<span class=\"token punctuation\">,</span> <span class=\"token constant\">VERIFIED_ID_EXPIRED_TIME_IN_MILLISECONDS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>이러한 역할의 분리는 또다른 효용을 불러일으키는데요. 바로 테스트 단위가 명확해지고 테스트가 편해진다는 것입니다. 기존의 코드가 모킹에 어려움이 있어 테스트가 어려웠던 사실을 기억하시나요? 개선된 코드는 테스트 내용이 명확해지고 모킹해야할 객체도 명확해졌습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@ExtendWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MockitoExtension</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">VerificationServiceTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Mock</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">SmsService</span> smsService<span class=\"token punctuation\">;</span>\n    <span class=\"token annotation punctuation\">@Mock</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">RandomCodeGenerator</span> randomCodeGenerator<span class=\"token punctuation\">;</span>\n    <span class=\"token annotation punctuation\">@Mock</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">RedisRepository</span> redisRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token annotation punctuation\">@InjectMocks</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">VerificationService</span> verificationService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">PHONE_NUMBER</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"01012345678\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">VERIFICATION_CODE</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"1234\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"인증코드 전송 후 저장\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">whenafterSendingCode_saveVerificationCodePhoneNumber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//given</span>\n        <span class=\"token function\">doNothing</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">when</span><span class=\"token punctuation\">(</span>smsService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sendOne</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PHONE_NUMBER</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">VERIFICATION_CODE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">when</span><span class=\"token punctuation\">(</span>randomCodeGenerator<span class=\"token punctuation\">.</span><span class=\"token function\">generate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">thenReturn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">VERIFICATION_CODE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//when</span>\n        verificationService<span class=\"token punctuation\">.</span><span class=\"token function\">sendMessage</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PHONE_NUMBER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// then</span>\n        <span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>smsService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sendOne</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PHONE_NUMBER</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">VERIFICATION_CODE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>redisRepository<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token function\">any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">smsService</code>와 <code class=\"language-text\">randomCodeGenerator</code>의 역할이 명확해지니 <code class=\"language-text\">VerificationService</code>의 작동 과정에서 어떻게 작동해야 하는지에 대한 명확한 설정이 가능합니다.</p>\n<h2>결론</h2>\n<p>이번 포스트에서는 의존성 주입과 SOLID 원칙을 통해 코드의 재사용성과 확장성을 높이면서, 테스트 가능한 코드를 작성하는 방법을 다루었습니다. 특히 SRP(단일 책임 원칙)와 DIP(의존 역전 원칙)를 적용하여 기존의 테스트가 어렵고 의존성이 높은 코드를 개선한 사례를 소개했습니다.</p>\n<p>코드가 단일 책임을 지니도록 분리하면서 <code class=\"language-text\">VerificationService</code>는 인증 코드 생성과 메시지 전송의 핵심 로직에만 집중하게 되었고, 이로 인해 다음과 같은 이점을 얻을 수 있었습니다:</p>\n<ol>\n<li>테스트 용이성 증가: 책임이 명확히 분리됨에 따라 각 구성 요소의 단위 테스트가 용이해졌고, 모킹할 객체도 명확해졌습니다. 그 결과, 테스트 작성의 복잡성을 줄이고 올바른 로직을 검증하는 데 필요한 테스트 설정이 간단해졌습니다.</li>\n<li>확장 가능성 향상: COOL SMS API와 같은 구체적인 구현에 대한 의존성을 줄임으로써, 다른 메시지 전송 기술로의 전환이 용이해졌습니다. 새로운 SMS 서비스로 변경하더라도, SmsService 인터페이스를 구현하는 클래스만 교체하면 되므로 코드 유지보수가 수월해졌습니다.</li>\n<li>유지보수성 개선: 코드의 책임이 명확히 분리되었기 때문에 코드의 가독성과 유지보수성이 향상되었습니다. 각 클래스와 메서드가 하나의 책임에 집중할 수 있어, 변경 사항이 발생해도 변경의 영향 범위를 최소화할 수 있습니다.</li>\n</ol>\n<p>이를 통해 테스트 가능한 코드가 단순히 기능적 요구를 충족하는 것뿐만 아니라, 장기적으로 시스템의 유연성과 신뢰성을 높이는 데 중요한 역할을 한다는 점을 확인할 수 있었습니다. 앞으로도 SOLID 원칙을 준수하며, 모듈화된 설계를 통해 변화에 유연하게 대응하는 코드를 작성하는 것이 중요함을 강조하고자 합니다.</p>\n<p>결론적으로, 코드의 테스트 가능성은 해당 코드의 품질을 높이는 중요한 요소이며, 이는 명확한 책임 분리와 의존성 관리에서 비롯됩니다. 앞으로도 코드 개선에 있어서 이러한 원칙들을 적용해 나가는 것이 필요합니다.</p>","frontmatter":{"title":"객체지향 OCP원칙과 DIP원칙의 적용 - 테스트가 용이하고 확장 가능한 코드 작성","date":"August 31, 2024","description":"개인 프로젝트 mall-fashion 개선기 #5"}},"previous":{"fields":{"slug":"/develop/mall-fashion/mall4/"},"frontmatter":{"title":"Continuous Delivery - 자동화된 QA 환경 구축"}},"next":null},"pageContext":{"id":"517f8966-1207-53fa-9b6b-c2b59b61f12b","previousPostId":"5be3e384-1619-5aa7-b5fd-3c1f71d99da9","nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}